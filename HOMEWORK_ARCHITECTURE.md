# Архитектура проекта: HR-ассистент с RAG

## Схема пайплайна

```
Пользователь (Telegram)
    ↓
handlers/
    ├── text.py      → обработка текстовых сообщений
    ├── voice.py     → обработка голосовых сообщений
    ├── image.py     → обработка изображений
    └── start.py      → команды управления (/mode, /index, /stats)
    ↓
services/router.py
    ├── route_text_request()        → маршрутизация текстовых запросов
    ├── route_voice_request()        → маршрутизация голосовых запросов
    ├── route_image_request()       → маршрутизация запросов на анализ изображений
    └── route_rag_request()          → маршрутизация RAG-запросов
    ↓
services/
    ├── openai_client.py    → взаимодействие с OpenAI API (GPT-4o)
    ├── stt.py              → распознавание речи (Whisper)
    ├── tts.py              → синтез речи (TTS-1)
    ├── vision.py           → анализ изображений (GPT-4 Vision)
    └── image_generation.py → генерация изображений (DALL-E 3)
    ↓
rag/
    ├── index.py    → создание и управление векторным индексом (ChromaDB)
    ├── loader.py   → загрузка и обработка документов
    └── query.py    → запросы к базе знаний с использованием RAG
    ↓
ChromaDB (векторная база данных)
    ↓
Ответ пользователю (Telegram)
```

## Описание структуры проекта

### handlers/ - Обработчики сообщений Telegram

Папка содержит модули для обработки различных типов сообщений от пользователей Telegram:
- `text.py` - обрабатывает текстовые сообщения, команды `/mode` и `/image`, определяет режим работы бота
- `voice.py` - обрабатывает голосовые сообщения, транскрибирует речь и отправляет голосовые ответы
- `image.py` - обрабатывает изображения, отправленные пользователями, для анализа через Vision API
- `start.py` - обрабатывает команды управления: `/start`, `/help`, `/reset`, `/index`, `/stats`

### services/ - Сервисы для работы с OpenAI API и маршрутизации

Папка содержит сервисные модули для взаимодействия с внешними API и маршрутизации запросов:
- `router.py` - центральный маршрутизатор, который определяет тип запроса и направляет его в соответствующий обработчик (текст, голос, изображение, RAG)
- `openai_client.py` - клиент для работы с OpenAI API, обеспечивает генерацию текстовых ответов через GPT-4o
- `stt.py` - сервис распознавания речи, преобразует голосовые сообщения в текст с помощью Whisper
- `tts.py` - сервис синтеза речи, преобразует текстовые ответы в голосовые сообщения с помощью TTS-1
- `vision.py` - сервис анализа изображений, использует GPT-4 Vision для распознавания и анализа визуального контента
- `image_generation.py` - сервис генерации изображений, создает изображения по текстовым описаниям с помощью DALL-E 3

### rag/ - Модули для работы с базой знаний

Папка содержит модули для реализации RAG (Retrieval-Augmented Generation) функциональности:
- `index.py` - управляет векторным индексом на основе ChromaDB, создает эмбеддинги документов с помощью OpenAI Embeddings, выполняет поиск похожих документов
- `loader.py` - загружает документы из различных форматов (txt, pdf, docx, md), разбивает их на чанки для индексации
- `query.py` - обрабатывает запросы к базе знаний, выполняет поиск релевантных документов и генерирует ответы с использованием найденного контекста

### utils/ - Вспомогательные функции

Папка содержит утилиты для поддержки работы приложения:
- `helpers.py` - управление сессиями пользователей, хранение истории диалогов, режимов работы и настроек голоса
- `logging.py` - настройка системы логирования для отслеживания работы приложения

### data/ - Хранилище данных

Папка содержит данные приложения:
- `documents/` - исходные документы для базы знаний (txt, pdf, docx файлы)
- `chroma_db/` - векторная база данных ChromaDB с индексированными эмбеддингами документов
- `generated_images/` - временное хранилище для сгенерированных изображений

## Как работает маршрутизация запросов

Маршрутизация запросов происходит в модуле `services/router.py`. Процесс работает следующим образом:

1. **Определение типа запроса**: В зависимости от типа входящего сообщения (текст, голос, изображение) вызывается соответствующий обработчик из папки `handlers/`.

2. **Маршрутизация по режиму**: Для текстовых запросов проверяется текущий режим работы пользователя (text, rag, voice, vision), который хранится в сессии пользователя.

3. **Обработка RAG-запросов**: Если режим установлен как `rag`, запрос направляется в модуль `rag/query.py`, который выполняет поиск в векторной базе данных ChromaDB и генерирует ответ на основе найденного контекста.

4. **Обработка обычных запросов**: Для режима `text` запрос обрабатывается напрямую через OpenAI API без использования базы знаний.

5. **Обработка голосовых запросов**: Голосовые сообщения сначала транскрибируются через STT, затем обрабатываются как текстовые запросы, после чего ответ синтезируется в голос через TTS.

6. **Обработка изображений**: Изображения анализируются через Vision API, а результаты добавляются в историю диалога для контекста последующих запросов.
